## 04-IP协议

### 4.1 IP即网协议

1. IP相当于网络层
2. 数据链路层提供直连的两个设备之间的通信，IP则负责在没有直连的两个网路之间进行通信传输

### 4.2 IP 基础知识

1. IP寻址：TCP/IP通信中所有主机或路由器必须设定自己的IP地址
2. 路由控制：是指将分组数据发送到最终目标地址的功能
   - 跳：指网络中的一个区间，每个区间内决定着包在下一跳被转发的路径
   - 多跳路由：指路由器或主机在转发IP数据包时只制定本下一个路由器或主机，而不是指定全部通路
   - 路由控制表：记录IP数据在下一步应该发给哪个路由器，IP包根据这个路由表在各个数据链路上传输
3. 数据链路抽象化：将数据链路的地址抽象为IP地址

### 4.3 IP 地址基础知识

1. 定义：IPv4地址由32位正整数表示
2. 组成：IP地址由网络地址和主机地址组成，保证唯一性
3. 分类：根据IP地址中前4位对网络标识和主机标识进行区分
   - A类：以0开头，1到8位是网络标识，后24位是主机标识，范围是0.0.0.0 ~ 127.0.0.0
   - B类：前两位是10，1到16位是网络标识，后16位是主机标识，范围是128.0.0.1 ~ 191.255.0.0
   - C类：前三位是110，1到24位是网络标识，后8位是主机标识，范围是192.168.0.0 ~ 239.255.255.0
   - D类：前四位是1110，1到32位是网络标识，没有主机标识，范围是224.0.0.0 ~ 239.255.255.255
4. 广播地址：IP地址中的主机地址全部设置为1。就成为广播地址
   - 本地广播：在本网络内广播
   - 直接广播：在不同网络之间广播
5. IP多播：将包发送给特定组内的所有主机，使用D类地址
6. 子网掩码：对于网络标识部分的位全部为1，对于主机标识部分全部为0，这样IP地址可以不受限与类别，使用子网掩码自由地定位自己的网络标识长度
7. CIDR与VLSM
   - CIDR（无类型域间选路）：采用任意长度分隔IP地址网络标识和主机标识，不用受限于IP地址分类
   - VISM（可变长子网掩码）：可以随机修改子网掩码长度
8. 全局地址与私有地址
   - 全局IP地址需要在整个互联网范围内唯一
   - 私有地址只要在同一个域里保证唯一即可
     - A类：10.0.0.1 ~ 10.255.255.255.255（10/8）
     - B类：172.16.0.0 ~ 172.31.255.255（172.16/12）
     - C类：192.168.0.0 ~ 192.168.255.255(192.168/16)

### 4.4 路由控制

1. IP 地址与路由控制
   - 路由控制表：记录网络地址和下一步应该发送至路由器的地址。首先确定IP包首部中的目标地址，再从路由控制表中找到与该地址具有相同网络地址的记录，根据该记录将IP包转发给相应的下一个路由器。若存在多条相同网络地址的记录，则选择相同位数最多的那个。
   - 默认路由：指路由表中任何一个地址都能与之匹配的记录，一般标记为0.0.0.0/0或default。
   - 主机路由：IP地址/32，表示整个IP地址的所有位都参与路由，意味着不基于该地址的网路地址部分进行路由
   - 环回地址：同一台计算机上的程序之间进行网路通信时使用的默认地址，为127.0.0.1，主机名为localhost。使用此IP或主机名时，数据包不流向网路。
2. 路由控制表的聚合：对内即使有多个子网掩码，对外也呈现同一个网络地址。
   - 实现：找出共同的网络地址，如172.18.129.0/24、172.18.130.0/24、172.18.132.0/24、172.18.133.0/24，聚合后的路由表为172.18.128.0/21

### 4.5 IP分割处理与再构成处理

1. 每种数据链路的最大传输单元（MTU）都不相同
2. IP 报文的分片与重组
   - 分片：IP包的字节数超过MTU时，路由器将其分片发送
   - 重组：由目标主机进行
3. 路径MTU发现：从发送端主机到接收端主机之间不需要分片时最大MTU的大小，尽量避免在中途的路由器上进行分片处理。

### 4.6 IPv6

1. 必要性：解决Ipv4地址即将耗尽的问题，长度为8个16位字节。
2. 特点：
   - 包首部长度采用固定的值（40字节），路由器不做分片处理
   - 不需要DHCP服务器也能自动分配IP地址
   - 采用认证和加密功能
   - 多播和Mobile IP可以使用

3. IP地址的标记方法
   - 16比特一组，每组用冒号隔开，若出现连续的0，可用两个冒号代替，但是只允许出现一次两个连续的冒号
4. IPv6地址的结构
   - 全局单播地址：世界上唯一的
   - 唯一本地地址：FC00: : /7
   - 链路本地单播地址：FE80: : /10

5. 全局单播地址：n比特的全局路由前缀 + m比特的子网ID + 128比特的接口ID
6. 链路本地单播地址：同一数据链路内唯一，接口ID保存64比特的Mac地址
7. 唯一本地地址：不进行互联网通信时所使用的地址，1111110 + L(通常是1) + 40比特的全局ID + 16比特的子网ID + 64比特的接口ID
8. IPv6分段处理：只在发送端主机上进行，路由器不参与分片，IPv6的最小MTU为1280字节

### 4.7 IPv4 首部

1. 版本：4比特
2. 首部长度：4比特，表示IP首部的大小，单位是4字节
3. 区分服务：8比特，表明服务质量
4. 总长度：16比特，表示IP首部与数据部分合起来的总字节数
5. 标识：16比特，用于分片重组
6. 标志：3比特，表示包被分片的相关信息
7. 片偏移：13比特，标识被分片的每一个分段相对于原始数据的位置
8. 生存时间：8比特，指可以中转多少路由器
9. 协议：8比特，表示IP首部的下一个首部隶属于哪个协议
10. 首部校验和：16比特，只校验数据报的首部，确保IP数据报不被破坏
11. 源地址：32比特，发送端IP地址
12. 目标地址：32比特，接收端IP地址
13. 可选项：长度可变，包含安全级别、源路径、路径记录、时间戳等
14. 填充：有可选项的情况下，首部长度可能不是32比特的整数倍，因此可以向该字段补0，将其调整为32比特的整数倍
15. 数据：存入数据

### 4.8 IPv6首部格式

1. 版本：4比特，值为6
2. 通信量类：8比特，相当于Ipv4的区分服务字段
3. 流标号：20比特，用于服务质量控制
4. 有效载荷长度：包的数据部分，不包含首部
5. 下一个首部：8比特，表示后面第一个扩展首部的协议类型
6. 跳数限制：8比特，数据没经过一次路由器就减1，减到0就丢弃数据
7. 源地址：128比特，发送端IP地址
8. 目标地址：128比特，接收端IP地址
9. IPv6扩展首部：介于IPv6首部与TCP/UDP首部中间。可以是任意长度